services:
  # Combined Geth + Node.js block generator service
  generate:
    build:
      context: .
      dockerfile: Dockerfile.combined-node
    container_name: blockchain-generator
    ports:
      - "8547:8545"
    volumes:
      - ./chain-data:/chain-data
      - ./generate-blocks.js:/app/generate-blocks.js
      - ./package.json:/app/package.json
      - ./geth-data:/root/.ethereum
    environment:
      - RPC_URL=http://localhost:8545
      - BLOCKS_JSON=/chain-data/blocks.json
      - DATA_DIR=/root/.ethereum
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "=========================================="
        echo "Blockchain Generation (Synchronized)"
        echo "=========================================="
        echo

        # Clean and initialize
        echo "Cleaning previous data..."
        rm -rf /root/.ethereum/geth /root/.ethereum/keystore

        echo "Initializing genesis..."
        geth init --datadir /root/.ethereum /chain-data/genesis.json

        # Start Geth with 5-second mining period (single stage)
        echo "Starting Geth with synchronized 5-second mining..."
        geth --datadir /root/.ethereum \
          --http --http.addr 0.0.0.0 --http.port 8545 \
          --http.api eth,net,web3,debug,personal,admin,miner,txpool \
          --http.corsdomain "*" --http.vhosts "*" \
          --allow-insecure-unlock --nodiscover --maxpeers 0 \
          --dev --dev.period 5 \
          --state.scheme=path \
          --txpool.pricelimit 0 --txpool.pricebump 0 \
          --verbosity 3 &

        GETH_PID=$$!

        # Wait for Geth to be ready
        for i in $$(seq 1 30); do
          if wget -q -O - http://localhost:8545 2>/dev/null; then
            echo "✓ Geth ready!"
            break
          fi
          sleep 0.2
        done

        # Start synchronized block generation
        echo "Starting synchronized block generation..."
        echo "Each block will be processed in sync with mining cycles"
        echo
        node /app/generate-blocks.js

        # Stop Geth after blockchain generation completes
        echo
        echo "Stopping Geth to prevent additional empty blocks..."
        kill $$GETH_PID
        sleep 2  # Give Geth time to shutdown gracefully
        echo "✓ Geth stopped. Blockchain ready for export."

        # Export blockchain (blocks 1-N, excluding genesis block 0)
        echo
        echo "=========================================="
        echo "Exporting Blockchain"
        echo "=========================================="

        # Determine the last block number from blocks.json (hex format)
        LAST_BLOCK_HEX=$$(grep '"number":' /chain-data/blocks.json | tail -1 | sed 's/.*"number":[[:space:]]*"\(0x[0-9a-fA-F]*\)".*/\1/')
        LAST_BLOCK=$$(printf "%d" $$LAST_BLOCK_HEX)

        if [ -z "$$LAST_BLOCK" ] || [ "$$LAST_BLOCK" -lt 1 ]; then
          echo "✗ Failed to determine last block number from blocks.json"
          echo "  Found: $$LAST_BLOCK_HEX -> $$LAST_BLOCK"
          exit 1
        fi

        echo "Exporting blocks 1-$$LAST_BLOCK to blocks.bin..."
        geth export /chain-data/blocks.bin 1 $$LAST_BLOCK --datadir /root/.ethereum

        if [ -f /chain-data/blocks.bin ]; then
          FILESIZE=$$(stat -c%s "/chain-data/blocks.bin" 2>/dev/null || stat -f%z "/chain-data/blocks.bin")
          echo "✓ Export complete: /chain-data/blocks.bin ($${FILESIZE} bytes)"
          echo "  Exported blocks: 1-$$LAST_BLOCK (genesis block 0 excluded)"
          echo
          echo "The exported blocks.bin can be used to replace:"
          echo "  debug-test-specs/chain-data/blocks.bin"
        else
          echo "✗ Export failed - blocks.bin not created"
          exit 1
        fi

networks:
  generate-network:
